# =============================================================================
# Forge Docker Compose
# Auto-detects GPU and uses appropriate configuration
# =============================================================================

services:
  # RTX 50-series (Blackwell) - sm_120
  forge-blackwell:
    build:
      context: ..
      dockerfile: docker/Dockerfile.blackwell
    image: forge:blackwell
    volumes:
      - ../data:/data
      - ../output:/output
      - ../checkpoints:/checkpoints
      - ../forge.yaml:/app/forge.yaml:ro
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NVIDIA_VISIBLE_DEVICES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    profiles:
      - blackwell
      - rtx50

  # RTX 40-series (Ada Lovelace) - sm_89
  forge-ada:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ada
    image: forge:ada
    volumes:
      - ../data:/data
      - ../output:/output
      - ../checkpoints:/checkpoints
      - ../forge.yaml:/app/forge.yaml:ro
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NVIDIA_VISIBLE_DEVICES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    profiles:
      - ada
      - rtx40

  # RTX 30-series (Ampere) - sm_86
  forge-ampere:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ampere
    image: forge:ampere
    volumes:
      - ../data:/data
      - ../output:/output
      - ../checkpoints:/checkpoints
      - ../forge.yaml:/app/forge.yaml:ro
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NVIDIA_VISIBLE_DEVICES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    profiles:
      - ampere
      - rtx30

  # H100/H200 (Hopper) - sm_90
  forge-hopper:
    build:
      context: ..
      dockerfile: docker/Dockerfile.hopper
    image: forge:hopper
    volumes:
      - ../data:/data
      - ../output:/output
      - ../checkpoints:/checkpoints
      - ../forge.yaml:/app/forge.yaml:ro
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NVIDIA_VISIBLE_DEVICES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    profiles:
      - hopper
      - h100

  # Auto-detect service (default)
  forge:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ada
    image: forge:auto
    volumes:
      - ../data:/data
      - ../output:/output
      - ../checkpoints:/checkpoints
      - ../forge.yaml:/app/forge.yaml:ro
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - NVIDIA_VISIBLE_DEVICES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
